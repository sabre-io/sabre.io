<!DOCTYPE html>
<head lang="en">

    
  
            <title>Virtual Filesystems - sabre/dav</title>
    
    <meta charset="utf-8">

    <link rel="alternate" type="application/atom+xml" href="https://sabre.io/atom.xml" title="sabre.io blog">
    <link rel="icon" href="https://sabre.io/favicon.ico">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:100,700,300,400" type="text/css">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <link rel="stylesheet" type="text/css" href="https://sabre.io/css/sabre.css">
    
</head>
<body >
    <header class="pagehead">

    <div class="pagehead-inner">
        <a class="logo" href="https://sabre.io/">
                            <img src="https://sabre.io/img/logo.png" alt="sabre/sabre/dav">
                sabre<span>/dav</span>
                    </a>

        <nav class="nav nav--page">
            <ul>
                <li class="size-auto"></li>
                <li><a href="https://sabre.io/dav">Docs</a></li>
                <li><a href="https://sabre.io/blog">Blog</a></li>
                <li><a href="https://sabre.io/support">Support</a></li>
                <li class="size-auto text--right"><a href="https://github.com/sabre-io"><i class="fa fa-github"></i></a></li>
                <!-- <li><a href="https://sabre.io/atom.xml"><i class="fa fa-rss"></i></a> <a href="https://twitter.com/sabredav"><i class="fa fa-twitter"></i></a></li> -->
            </ul>
        </nav>

    </div>

</header>

            <input class="hamburger-input" type="checkbox" id="nav-check" name="nav-check">
        <label class="hamburger-label" for="nav-check"><i class="fa fa-bars"></i></label>
    
        <main class="incl-sidebar">
                    <aside class="sidebar">
    <nav class="nav nav--sidebar">
        <ul class="list list--nav">
            <li><a href="https://sabre.io/dav">sabre/dav</a>
                                <ul>
                    <li><a href="https://sabre.io/dav/install">Installation</a></li>
                    <li><a href="https://sabre.io/dav/upgrading">Upgrading</a></li>
                    <li><a href="https://sabre.io/dav/gettingstarted">Getting Started</a></li>
                    <li><a href="https://sabre.io/dav/extending-sabredav">Extending sabre/dav</a></li>
                    <li>Troubleshooting
                        <ul>
                            <li><a href="https://sabre.io/dav/faq">FAQ</a></li>
                            <li><a href="https://sabre.io/dav/clients">Clients</a></li>
                            <li><a href="https://sabre.io/dav/webservers">Webservers</a></li>
                        </ul>
                    </li>
                    <li>CalDAV
                        <ul>
                            <li><a href="https://sabre.io/dav/caldav">Getting started</a></li>
                            <li><a href="https://sabre.io/dav/building-a-caldav-client">Building a CalDAV client</a></li>
                            <li><a href="https://sabre.io/dav/caldav-carddav-integration-guide">Integration guide</a></li>
                            <li><a href="https://sabre.io/dav/caldav-proxy">Delegation</a></li>
                            <li><a href="https://sabre.io/dav/caldav-sharing">Calendar sharing</a></li>
                            <li><a href="https://sabre.io/dav/ics-export-plugin">iCalendar export</a></li>
                            <li><a href="https://sabre.io/dav/scheduling">Scheduling</a></li>
                            <li><a href="https://sabre.io/dav/service-discovery">Service Discovery</a></li>
                        </ul>
                    </li>
                    <li>CardDAV
                        <ul>
                            <li><a href="https://sabre.io/dav/carddav/">Getting started</a></li>
                            <li><a href="https://sabre.io/dav/building-a-carddav-client/">Building a CardDAV client</a></li>
                            <li><a href="https://sabre.io/dav/caldav-carddav-integration-guide/">Integration guide</a></li>
                            <li><a href="https://sabre.io/dav/carddav-directory/">CardDAV Directory</a></li>
                            <li><a href="https://sabre.io/dav/vcf-export-plugin/">vCard export</a></li>
                            <li><a href="https://sabre.io/dav/carddav-me-card/">Me-card</a></li>
                            <li><a href="https://sabre.io/dav/service-discovery/">Service Discovery</a></li>
                        </ul>
                    </li>
                    <li>Other topics
                        <ul>
                            <li><a href="https://sabre.io/dav/acl">Acl</a></li>
                            <li><a href="https://sabre.io/dav/authentication">Authentication</a></li>
                            <li><a href="https://sabre.io/dav/character-encoding">Character encoding</a></li>
                            <li><a href="https://sabre.io/dav/browser-plugin">Directory indexes</a></li>
                            <li><a href="https://sabre.io/dav/davmount">DavMount</a></li>
                            <li><a href="https://sabre.io/dav/guesscontenttype">Content Types</a></li>
                            <li><a href="https://sabre.io/dav/http-patch">PATCH support</a></li>
                            <li><a href="https://sabre.io/dav/large-files">Large files</a></li>
                            <li><a href="https://sabre.io/dav/litmus">Litmus</a></li>
                            <li><a href="https://sabre.io/dav/locks">Locks</a></li>
                            <li><a href="https://sabre.io/dav/plugins">Plugins</a></li>
                            <li><a href="https://sabre.io/dav/per-user-directories/">Per-user directories</a></li>
                            <li><a href="https://sabre.io/dav/properties">Properties</a></li>
                            <li><a href="https://sabre.io/dav/property-storage">Property storage</a></li>
                            <li><a href="https://sabre.io/dav/scalability">Scalability</a></li>
                            <li><a href="https://sabre.io/dav/simplecollection">SimpleCollection</a></li>
                            <li><a href="https://sabre.io/dav/standards-support">Standards Support</a></li>
                            <li><a href="https://sabre.io/dav/temporary-files">Temporary Files</a></li>
                            <li><a href="https://sabre.io/dav/versioning">Versioning</a></li>
                            <li><a href="https://sabre.io/dav/virtual-filesystems">Virtual filesystems</a></li>
                            <li><a href="https://sabre.io/dav/davclient">WebDAV client</a></li>
                            <li><a href="https://sabre.io/dav/sync">WebDAV sync</a></li>
                            <li><a href="https://sabre.io/dav/writing-plugins">Writing Plugins</a></li>
                            <li><a href="https://sabre.io/dav/xmlelements">XML Elements</a></li>
                        </ul>
                    </li>
                </ul>
                            </li>
            <li><a href="https://sabre.io/event">sabre/event</a>
                            </li>
            <li><a href="https://sabre.io/http">sabre/http</a>
                            </li>
            <li><a href="https://sabre.io/katana">sabre/katana</a>
                            </li>
            <li><a href="https://sabre.io/vobject">sabre/vobject</a>
                            </li>
            <li><a href="https://sabre.io/xml">sabre/xml</a>
                            </li>
            <li><a href="https://sabre.io/uri">sabre/uri</a>
                            </li>
            <li><a href="https://sabre.io/baikal/">Baïkal</a>
                            </li>
            <li><a href="https://sabre.io/license">License</a></li>
        </ul>
    </nav>
</aside>
                <article>
                            <h1>Virtual Filesystems</h1>
                <p>SabreDAV is built to easily adapt existing business logic onto a virtual
network filesystem. This document explores how this can be setup.</p>

<ul>
<li>It is assumed in this tutorial that the reader has already gone through the
<a href="/dav/gettingstarted">GettingStarted</a> and <a href="/dav/faq">FAQ</a> manuals.</li>
<li>In the code examples it is assumed all mentioned classes are currently
loaded in through an include.</li>
</ul>

<h2 id="high-level-api">High-level API</h2>

<p>SabreDAV is shipped with an API that should ease creating directory-tree structures.</p>

<h2 id="files-and-directories">Files and Directories</h2>

<p>Files and Directories both implement the <code>Sabre\DAV\INode</code> interface, this interface dictates the following methods should be implemented:</p>

<ul>
<li><code>delete()</code> - deletes the file/directory.</li>
<li><code>getName()</code> - returns the file/directory name.</li>
<li><code>setName($newName)</code> - renames the directory.</li>
<li><code>getLastModified()</code> - returns the last modification time as a unix timestamp.</li>
</ul>

<p>Additionally File objects need to implement the following methods:</p>

<ul>
<li><code>put($data)</code> updates the data in the file.</li>
<li><code>get()</code> returns the contents of the file.</li>
<li><code>getETag()</code> - returns a unique identifier of the current state of the file. If the file changes, so should the etag. Etags are surrounded by quotes.</li>
<li><code>getContentType()</code> - returns the mime-type of the file.</li>
<li><code>getSize()</code> - returns the size in bytes.</li>
</ul>

<p>Directories/Collections objects add the following:</p>

<ul>
<li><code>getChild($name)</code> - Returns a File or Directory object for the child-node of the given name.</li>
<li><code>getChildren()</code> - Returns an array of File and/or Directory objects.</li>
<li><code>createFile($name,$data)</code> - Creates a new file with the given name.</li>
<li><code>createDirectory($name)</code> - Creates a subdirectory with the given name.</li>
<li><code>childExists($name)</code> - Returns true if a child node exists.</li>
</ul>

<h2 id="inheritance-tree">Inheritance tree</h2>

<pre><code>Sabre\DAV\INode (base interface for all nodes in a tree)
 +-Sabre\DAV\IFile (base interface for all files)
 |  +-Sabre\DAV\File (base helper class)
 |
 +-Sabre\DAV\ICollection (base interface for all directories)
    +-Sabre\DAV\Collection (base helper class)
</code></pre>

<p>Next to the interfaces, there are two helper classes in this diagram
(<code>Sabre\DAV\File</code> and <code>Sabre\DAV\Collection</code>). These classes are an easy
starting point, as they will lock down most operations by default (by
reporting 'permission denied'), so we can start with a read-only filesystem.</p>

<h2 id="implementation">Implementation</h2>

<p>Our read-only filesystem is going to be based off the standard server filesystem.</p>

<h3 id="getting-the-classes-ready">Getting the classes ready</h3>

<p>For this demonstration we need to create 2 classes, one for a directory and one for a file. We'll start out with the Directory class:</p>

<pre><code>use Sabre\DAV;

class MyDirectory extends DAV\Collection {

  private $myPath;

  function __construct($myPath) {

    $this-&gt;myPath = $myPath;

  }

  function getChildren() {

    $children = array();
    // Loop through the directory, and create objects for each node
    foreach(scandir($this-&gt;myPath) as $node) {

      // Ignoring files staring with .
      if ($node[0]==='.') continue;
      $children[] = $this-&gt;getChild($node);

    }

    return $children;

  }

  function getChild($name) {

      $path = $this-&gt;myPath . '/' . $name;

      // We have to throw a NotFound exception if the file didn't exist
      if (!file_exists($path)) {
        throw new DAV\Exception\NotFound('The file with name: ' . $name . ' could not be found');
      }

      // Some added security
      if ($name[0]=='.')  throw new DAV\Exception\NotFound('Access denied');

      if (is_dir($path)) {

          return new MyDirectory($path);

      } else {

          return new MyFile($path);

      }

  }

  function childExists($name) {

        return file_exists($this-&gt;myPath . '/' . $name);

  }

  function getName() {

      return basename($this-&gt;myPath);

  }

}
</code></pre>

<p>In the example is shown the absolute minimum of methods that need to be
implemented in order to create a read-only directory. I'm hoping the code will
speak for itself.</p>

<p>Same goes for the MyFile class:</p>

<pre><code>use Sabre\DAV;

class MyFile extends DAV\File {

  private $myPath;

  function __construct($myPath) {

    $this-&gt;myPath = $myPath;

  }

  function getName() {

    return basename($this-&gt;myPath);

  }

  function get() {

    return fopen($this-&gt;myPath,'r');

  }

  function getSize() {

    return filesize($this-&gt;myPath);

  }

  function getETag() {

    return '"' . md5_file($this-&gt;myPath) . '"';

  }

}
</code></pre>

<p>It's important thing to note is, that you should usually not pass strings
around. Although the <code>get()</code> method can just return a string, especially with
larger files it's recommended to use streams (as shown with fopen). The
<code>put()</code> and <code>createFile()</code> methods will always get a readable stream resource
as arguments.</p>

<h3 id="setting-up">Setting up</h3>

<p>I'm explaining the usage of your newly created server through code comments</p>

<pre><code>use Sabre\DAV;

// Make sure there is a directory in your current directory named 'public'. We will be exposing that directory to WebDAV
$publicDir = new MyDirectory('public');

// The object tree needs in turn to be passed to the server class
$server = new DAV\Server($publicDir);

// We're required to set the base uri, it is recommended to put your webdav server on a root of a domain
$server-&gt;setBaseUri('/');

// And off we go!
$server-&gt;exec();
</code></pre>

<h3 id="this-is-not-virtual">This is not virtual</h3>

<p>That's right! This is where you come in. You can make your MyFile and
MyDirectory classes completely independently of the actual underlying
filesystem. The list of items returned from <code>getChildren</code> could be a list of
blogposts, and the <code>get</code> method could return html data.</p>

<h2 id="write-support">Write support</h2>

<p>In order to get writing/modification support you should implement all the
remaining methods. A good example of a completely built-out system like this
can be found in the <code>Sabre\DAV\FS</code> directory. This system should closely mimic
apache's mod_dav. Implementation of these is up to you (and optional) and is
not written out in this manual, because at this point this should be fairly
simple.</p>

<p>However, this is not enough. <a href="/dav/clients/finder">OS/X Finder</a> and
<a href="/dav/clients/davfs">DavFS</a> will demand you add locking support to your
filesystem.</p>

<h2 id="further-reading">Further reading</h2>

<ul>
<li><a href="/dav/authentication/">Authentication</a></li>
<li><a href="/dav/locks/">Support for WebDAV LOCK and UNLOCK</a></li>
<li><a href="/dav/per-user-directories/">Per-user directories</a></li>
<li><a href="/dav/temporary-files/">Temporary files</a></li>
</ul>
            
            
                    </article>
    </main>
    
    <!-- this is where the ugly bit starts. Stupid javascript :( -->

    <script src="https://sabre.io/components/highlightjs/highlight.pack.js"></script>
    <script>
        hljs.configure({languages: ['php']});
        hljs.initHighlightingOnLoad();
    </script>

    <script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');
ga('create', 'UA-2848664-5', 'sabre.io');
ga('send', 'pageview');
</script>

    
    <footer>

    <nav>
        <ul>
            <li>© 2023 <a href="https://fruux.com">fruux GmbH</a> · </li>
            <li><a href="https://sabre.io/support">Contact</a> · </li>
            <li><a href="https://sabre.io/legal">Legal Info</a></li>
        </ul>
        <ul>
            <li><i class="fa fa-twitter"></i> <a href="https://twitter.com/sabredav">@sabredav</a> · </li>
            <li><a href="https://twitter.com/fruux">@fruux</a></li>
                    </ul>
    </nav>

</footer>

</body>
